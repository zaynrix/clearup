rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Users collection
    // - Users can create their own document during registration
    // - Users can read/update their own document
    // - Admins can read/update/delete all users
    match /users/{userId} {
      // Allow users to create their own document during registration
      // Allow admins to create any user document
      allow create: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      // Allow users to read their own document
      // Allow admins to read all user documents
      allow read: if isOwner(userId) || isAdmin();
      
      // Allow users to update their own document
      // Allow admins to update any user document
      allow update: if isOwner(userId) || isAdmin();
      
      // Allow admins to delete any user document
      // Users cannot delete their own document (for safety)
      allow delete: if isAdmin();
    }
    
    // WhatsApp leads collection
    // - Anyone can create leads (for form submissions)
    // - Authenticated users can read all leads (for admin dashboard)
    // - Authenticated users can update/delete leads
    match /whatsapp_leads/{leadId} {
      // Allow anyone to create leads (for public form submissions)
      allow create: if true;
      
      // Allow authenticated users to read leads
      allow read: if isAuthenticated();
      
      // Allow authenticated users to update/delete leads
      allow update, delete: if isAuthenticated();
    }
    
    // Email submissions collection
    // - Anyone can create submissions (for form submissions from website)
    // - Authenticated users can read all submissions (for admin dashboard)
    // - Authenticated users can update/delete submissions
    match /email_submissions/{submissionId} {
      // Allow anyone to create email submissions (for public form submissions)
      allow create: if true;
      
      // Allow authenticated users to read submissions
      allow read: if isAuthenticated();
      
      // Allow authenticated users to update/delete submissions
      allow update, delete: if isAuthenticated();
    }
    
    // Home content collection
    // - Anyone can read (for displaying homepage)
    // - Only authenticated users can write (for admin dashboard)
    match /home_content/{documentId} {
      // Allow anyone to read home content (for public homepage)
      allow read: if true;
      
      // Allow authenticated users to create/update/delete
      allow write: if isAuthenticated();
    }
    
    // Roles collection
    // - Authenticated users can read roles (to check their own permissions)
    // - Only admins can write (create/update/delete) roles
    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Activity logs collection
    // - Only admins can read all logs
    // - Authenticated users can create logs (for tracking their actions)
    match /activity_logs/{logId} {
      // Allow authenticated users to create logs
      allow create: if isAuthenticated();
      
      // Only admins can read logs
      allow read: if isAdmin();
      
      // Only admins can update/delete logs
      allow update, delete: if isAdmin();
    }
    
    // Site settings collection
    // - Anyone can read (for checking disabled sections)
    // - Only admins can write
    match /site_settings/{documentId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // About content collection
    // - Anyone can read (for displaying about page)
    // - Only authenticated users can write (for admin dashboard)
    match /aboutContent/{documentId} {
      // Allow anyone to read about content (for public about page)
      allow read: if true;
      
      // Allow authenticated users to create/update/delete
      allow write: if isAuthenticated();
    }
    
    // Services Content - anyone can read, authenticated users can write
    match /servicesContent/{documentId} {
      // Allow anyone to read services content (for public services page)
      allow read: if true;
      
      // Allow authenticated users to create/update/delete
      allow write: if isAuthenticated();
    }
    
    // Site content collection (legal pages, etc.)
    // - Anyone can read (for displaying public pages like privacy policy, terms, cookies)
    // - Only authenticated users can write (for admin dashboard)
    match /site_content/{documentId} {
      // Allow anyone to read site content (for public pages)
      allow read: if true;
      
      // Allow authenticated users to create/update/delete
      allow write: if isAuthenticated();
    }
    
    // Contact messages collection
    // - Anyone can create messages (for public contact form submissions)
    // - Authenticated users can read all messages (for admin dashboard)
    // - Authenticated users can update/delete messages
    match /contactMessages/{messageId} {
      // Allow anyone to create contact messages (for public form submissions)
      allow create: if true;
      
      // Allow authenticated users to read messages
      allow read: if isAuthenticated();
      
      // Allow authenticated users to update/delete messages
      allow update, delete: if isAuthenticated();
    }
    
    // Contact content collection
    // - Anyone can read (for displaying contact page)
    // - Only authenticated users can write (for admin dashboard)
    match /contactContent/{documentId} {
      // Allow anyone to read contact content (for public contact page)
      allow read: if true;
      
      // Allow authenticated users to create/update/delete
      allow write: if isAuthenticated();
    }
    
  // Bookings collection
  // - Anyone can create bookings (for public booking form)
  // - Authenticated users can read their own bookings
  // - Admins can read/update/delete all bookings
  match /bookings/{bookingId} {
    // Allow anyone to create bookings (for public booking form)
    allow create: if true;
    
    // Allow users to read their own bookings (by email)
    // Allow admins to read all bookings
    allow read: if isAuthenticated() && (
      resource.data.userEmail == request.auth.token.email ||
      isAdmin()
    );
    
    // Allow admins to update/delete bookings
    // Allow users to update their own bookings (for cancellation)
    allow update, delete: if isAuthenticated() && (
      isAdmin() ||
      (resource.data.userEmail == request.auth.token.email && request.resource.data.status == 'cancelled')
    );
  }
  
  // Availability collection
  // - Anyone can read (for guests to check availability when booking)
  // - Only admins can write (block/unblock time slots)
  match /availability/{availabilityId} {
    // Allow anyone to read availability (for public booking form)
    allow read: if true;
    
    // Only admins can create/update/delete availability
    allow write: if isAdmin();
  }
  
  // Default deny rule for any other collections
  match /{document=**} {
    allow read, write: if false;
  }
}
}

