rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Users collection
    // - Users can create their own document during registration
    // - Users can read/update their own document
    // - Admins can read/update/delete all users
    match /users/{userId} {
      // Allow users to create their own document during registration
      // Allow admins to create any user document
      allow create: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      // Allow users to read their own document
      // Allow admins to read all user documents
      allow read: if isOwner(userId) || isAdmin();
      
      // Allow users to update their own document
      // Allow admins to update any user document
      allow update: if isOwner(userId) || isAdmin();
      
      // Allow admins to delete any user document
      // Users cannot delete their own document (for safety)
      allow delete: if isAdmin();
    }
    
    // WhatsApp leads collection
    // - Anyone can create leads (for form submissions)
    // - Authenticated users can read all leads (for admin dashboard)
    // - Authenticated users can update/delete leads
    match /whatsapp_leads/{leadId} {
      // Allow anyone to create leads (for public form submissions)
      allow create: if true;
      
      // Allow authenticated users to read leads
      allow read: if isAuthenticated();
      
      // Allow authenticated users to update/delete leads
      allow update, delete: if isAuthenticated();
    }
    
    // Email submissions collection
    // - Anyone can create submissions (for form submissions from website)
    // - Authenticated users can read all submissions (for admin dashboard)
    // - Authenticated users can update/delete submissions
    match /email_submissions/{submissionId} {
      // Allow anyone to create email submissions (for public form submissions)
      allow create: if true;
      
      // Allow authenticated users to read submissions
      allow read: if isAuthenticated();
      
      // Allow authenticated users to update/delete submissions
      allow update, delete: if isAuthenticated();
    }
    
    // Home content collection
    // - Anyone can read (for displaying homepage)
    // - Only authenticated users can write (for admin dashboard)
    match /home_content/{documentId} {
      // Allow anyone to read home content (for public homepage)
      allow read: if true;
      
      // Allow authenticated users to create/update/delete
      allow write: if isAuthenticated();
    }
    
    // Roles collection
    // - Authenticated users can read roles (to check their own permissions)
    // - Only admins can write (create/update/delete) roles
    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Activity logs collection
    // - Only admins can read all logs
    // - Authenticated users can create logs (for tracking their actions)
    match /activity_logs/{logId} {
      // Allow authenticated users to create logs
      allow create: if isAuthenticated();
      
      // Only admins can read logs
      allow read: if isAdmin();
      
      // Only admins can update/delete logs
      allow update, delete: if isAdmin();
    }
    
    // Site settings collection
    // - Anyone can read (for checking disabled sections)
    // - Only admins can write
    match /site_settings/{documentId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // About content collection
    // - Anyone can read (for displaying about page)
    // - Only authenticated users can write (for admin dashboard)
    match /aboutContent/{documentId} {
      // Allow anyone to read about content (for public about page)
      allow read: if true;
      
      // Allow authenticated users to create/update/delete
      allow write: if isAuthenticated();
    }
    
    // Services Content - anyone can read, authenticated users can write
    match /servicesContent/{documentId} {
      // Allow anyone to read services content (for public services page)
      allow read: if true;
      
      // Allow authenticated users to create/update/delete
      allow write: if isAuthenticated();
    }
    
    // Site content collection (legal pages, etc.)
    // - Anyone can read (for displaying public pages like privacy policy, terms, cookies)
    // - Only authenticated users can write (for admin dashboard)
    match /site_content/{documentId} {
      // Allow anyone to read site content (for public pages)
      allow read: if true;
      
      // Allow authenticated users to create/update/delete
      allow write: if isAuthenticated();
    }
    
    // Contact messages collection
    // - Anyone can create messages (for public contact form submissions)
    // - Authenticated users can read all messages (for admin dashboard)
    // - Authenticated users can update/delete messages
    match /contactMessages/{messageId} {
      // Allow anyone to create contact messages (for public form submissions)
      allow create: if true;
      
      // Allow authenticated users to read messages
      allow read: if isAuthenticated();
      
      // Allow authenticated users to update/delete messages
      allow update, delete: if isAuthenticated();
    }
    
    // Contact content collection
    // - Anyone can read (for displaying contact page)
    // - Only authenticated users can write (for admin dashboard)
    match /contactContent/{documentId} {
      // Allow anyone to read contact content (for public contact page)
      allow read: if true;
      
      // Allow authenticated users to create/update/delete
      allow write: if isAuthenticated();
    }
    
  // Bookings collection
  // - Anyone can create bookings (for public booking form)
  // - Anyone can read bookings (to check availability - only meetingDate and meetingTime are needed)
  // - Authenticated users can read their own bookings with full details
  // - Admins can read/update/delete all bookings
  match /bookings/{bookingId} {
    // Allow anyone to create bookings (for public booking form)
    allow create: if true;
    
    // Allow anyone to read bookings (for checking availability)
    // This allows guests to see which time slots are booked
    allow read: if true;
    
    // Allow updates:
    // 1. Admins can update any booking
    // 2. Authenticated users can update their own bookings (for cancellation)
    // 3. Allow updates to guest bookings (no userId field) immediately after creation
    //    This is needed because the booking controller updates the booking right after creation
    //    to set the meeting link, status, googleEventId, calendarLink, adminId, and ID.
    //    We verify by checking email/name match and that user-provided data hasn't changed.
    allow update: if isAdmin() ||
      (isAuthenticated() && resource.data.userEmail == request.auth.token.email && request.resource.data.status == 'cancelled') ||
      (!isAuthenticated() && 
       // Verify it's a guest booking (no userId field exists)
       !('userId' in resource.data) &&
       // Verify email and name match (same person) - these are the key identifiers
       request.resource.data.userEmail == resource.data.userEmail &&
       request.resource.data.userName == resource.data.userName &&
       // Verify essential user-provided data hasn't changed
       // Note: Date comparison works for both Timestamp and string formats in Firestore
       request.resource.data.meetingDate == resource.data.meetingDate &&
       request.resource.data.meetingTime == resource.data.meetingTime &&
       // Allow optional user fields to match or be absent (phone, contactMethod, notes)
       (!('userPhone' in request.resource.data) || !('userPhone' in resource.data) || request.resource.data.userPhone == resource.data.userPhone) &&
       (!('contactMethod' in request.resource.data) || !('contactMethod' in resource.data) || request.resource.data.contactMethod == resource.data.contactMethod) &&
       (!('notes' in request.resource.data) || !('notes' in resource.data) || request.resource.data.notes == resource.data.notes));
    
    // Allow deletes:
    // 1. Admins can delete any booking
    // 2. Authenticated users can delete their own bookings
    allow delete: if isAdmin() ||
      (isAuthenticated() && resource.data.userEmail == request.auth.token.email);
  }
  
  // Availability collection
  // - Anyone can read (for guests to check availability when booking)
  // - Only admins can write (block/unblock time slots)
  match /availability/{availabilityId} {
    // Allow anyone to read availability (for public booking form)
    allow read: if true;
    
    // Only admins can create/update/delete availability
    allow write: if isAdmin();
  }
  
  // Maintenance requests collection
  // - Anyone can read active maintenance requests (to check if site is in maintenance)
  // - Only admins can create/update/delete maintenance requests
  match /maintenance_requests/{requestId} {
    // Allow anyone to read maintenance requests (to check if site is in maintenance mode)
    allow read: if true;
    
    // Only admins can create/update/delete maintenance requests
    allow write: if isAdmin();
  }
  
  // Analytics visits collection
  // - Anyone can create visits (for tracking page visits)
  // - Only admins can read analytics data (for dashboard)
  match /analytics_visits/{visitId} {
    // Allow anyone to create visits (for tracking page visits)
    allow create: if true;
    
    // Only admins can read analytics data
    allow read: if isAdmin();
    
    // Only admins can update/delete analytics data
    allow update, delete: if isAdmin();
  }
  
  // Admins collection
  // - Only admins can read/write their own admin document (for Google Calendar tokens)
  // - Admins can only access their own document (by ID matching their user ID)
  // - Tokens are private and should never be exposed to public
  match /admins/{adminId} {
    // Allow admins to create/update their own admin document
    allow create, update: if isAuthenticated() && 
                          isAdmin() && 
                          request.auth.uid == adminId;
    
    // Allow admins to read their own admin document only
    allow read: if isAuthenticated() && 
                 isAdmin() && 
                 request.auth.uid == adminId;
    
    // Admins cannot delete their own admin document (for safety)
    allow delete: if false;
  }
  
  // Calendar status collection (public read, admin write only)
  // - Anyone can read calendar status (for checking if booking is available)
  // - Only admins can update calendar status
  // - This collection stores only safe, non-sensitive data
  match /calendar_status/{statusId} {
    // Allow anyone to read calendar status (for checking if booking is available)
    allow read: if true;
    
    // Only admins can create/update calendar status
    allow create, update: if isAuthenticated() && isAdmin();
    
    // Only admins can delete calendar status
    allow delete: if isAuthenticated() && isAdmin();
  }
  
  // Default deny rule for any other collections
  match /{document=**} {
    allow read, write: if false;
  }
}
}

